<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI HARUOMI｜HARUOMILABO</title>
  <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/3eb4b2_ee219c7f48d34f2fadd5589796c84049~mv2.png" />
  <style>
    html, body {
      width: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #1a1a1a;
      color: #e0e0e0;
      box-sizing: border-box;
    }
    body {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    .logo-image {
      max-width: 100%;
      height: auto;
      margin: 0 auto;
      display: block;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      border-radius: 8px;
    }
    #chat-container {
      background: #2d2d2d;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      height: 400px;
      overflow-y: auto;
      margin-bottom: 10px;
      border: 1px solid #404040;
      width: 100%;
      box-sizing: border-box;
    }
    .message {
      margin: 10px 0;
      padding: 12px;
      border-radius: 8px;
      word-wrap: break-word;
    }
    .user-message {
      background: #007bff;
      color: white;
      text-align: right;
      border-bottom-right-radius: 2px;
    }
    .bot-message {
      background: #404040;
      color: #e0e0e0;
      border: 1px solid #555;
      border-bottom-left-radius: 2px;
    }
    .official-link {
      font-size: 0.9em;
      color: white;
      text-align: center;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #555;
    }
    .official-link a {
      color: white;
      text-decoration: none;
    }
    .official-link a:hover {
      color: #cccccc;
      text-decoration: underline;
    }
    #input-container {
      display: flex;
      background: #2d2d2d;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #404040;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    #user-input {
      flex: 1;
      padding: 12px;
      border: none;
      background: #3a3a3a;
      color: #e0e0e0;
      outline: none;
      min-width: 0;
    }
    #user-input::placeholder {
      color: #888;
    }
    #send-btn {
      padding: 12px 20px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    #send-btn:hover {
      background: #0056b3;
    }
    #clear-history {
      padding: 10px 20px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      margin-left: 10px;
    }
    #clear-history:hover {
      background: #ff5252;
    }
    #save-history-toggle-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    #save-history-toggle {
      margin-right: 8px;
    }
    .history-section {
      background: #333;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border: 1px solid #555;
    }
    .history-title {
      font-size: 1.1em;
      color: #66b3ff;
      margin-bottom: 10px;
      text-align: center;
    }
    .history-message {
      margin: 5px 0;
      padding: 8px;
      background: #404040;
      border-radius: 5px;
      font-size: 0.9em;
    }
    .history-user {
      text-align: right;
      color: #007bff;
    }
    .history-bot {
      text-align: left;
      color: #e0e0e0;
    }
    #chat-container::-webkit-scrollbar {
      width: 8px;
    }
    #chat-container::-webkit-scrollbar-track {
      background: #2d2d2d;
    }
    #chat-container::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }
    #chat-container::-webkit-scrollbar-thumb:hover {
      background: #666;
    }
    .terms-link {
      text-align: center;
      margin-top: 30px;
      font-size: 0.85em;
    }
    .terms-link a {
      color: #cccccc;
      text-decoration: none;
    }
    .terms-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://static.wixstatic.com/media/3eb4b2_3bd41a6518f046cb934d548fb06fdf89~mv2.png" alt="AI HARUOMI Logo" class="logo-image">
  </header>

  <div id="history-section" class="history-section" style="display: none;">
    <div class="history-title">過去の会話履歴</div>
    <div id="history-messages"></div>
  </div>

  <div id="chat-container">
    <div class="message bot-message">
      こんにちは 私はAI HARUOMI です！<br>
      HARUOMILABOに関する質問などをしたのチャットから質問入力してください
    </div>
  </div>

  <div id="input-container">
    <input type="text" id="user-input" placeholder="メッセージを入力...">
    <button id="send-btn">送信</button>
  </div>

  <div id="save-history-toggle-container">
    <input type="checkbox" id="save-history-toggle">
    <label for="save-history-toggle">履歴を保存する</label>
    <button id="clear-history">履歴をクリア</button>
  </div>

  <div class="terms-link">
    <a href="https://www.haruomilabo.com/_files/ugd/3eb4b2_a17da8e3b70640f3899ba7526efcb000.pdf" target="_blank">必ずお読みください｜利用規約</a>
  </div>

  <script>
    const chatContainer = document.getElementById('chat-container');
    const historySection = document.getElementById('history-section');
    const historyMessages = document.getElementById('history-messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const clearHistoryBtn = document.getElementById('clear-history');
    const saveHistoryToggle = document.getElementById('save-history-toggle');

    const STORAGE_KEY = 'haruomiChatHistory';

    const responses = {
      greeting: {
        keywords: ['こんにちは', 'こんばんは', 'おはよう'],
        variations: ['こんにちは！HARUOMILABOについて何か知りたいことはありますか？']
      },
      haruomilabo: {
        keywords: ['haruomilabo', 'ハルオミラボ'],
        variations: ['HARUOMILABOは内藤春臣が2024年に設立した団体です。']
      },
      default: {
        keywords: [],
        variations: [
          '申し訳ありませんが、その質問にはお答えできません。<br><a href="https://www.haruomilabo.com" target="_blank">公式サイト</a>をご覧ください。'
        ]
      }
    };

    function getRandomVariation(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getBotResponse(input) {
      const lowerInput = input.toLowerCase().trim();
      for (const [category, data] of Object.entries(responses)) {
        if (category === 'default') continue;
        for (const keyword of data.keywords) {
          if (lowerInput.includes(keyword.toLowerCase())) {
            return getRandomVariation(data.variations);
          }
        }
      }
      return getRandomVariation(responses['default'].variations);
    }

    function addMessage(text, isUser) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
      if (isUser) {
        messageDiv.textContent = text;
      } else {
        const textWithLink = text + '<div class="official-link">公式HP：<a href="https://www.haruomilabo.com" target="_blank">https://www.haruomilabo.com</a></div>';
        messageDiv.innerHTML = textWithLink;
      }
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function saveToHistory(userMsg, botMsg) {
      if (!saveHistoryToggle.checked) return;
      let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      history.push({ user: userMsg, bot: botMsg });

      // 最新3件に制限
      if (history.length > 3) {
        history = history.slice(-3);
      }

      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }

    function loadHistory() {
      const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      if (history.length > 0) {
        const recentHistory = history.slice(-3); // 念のため制限
        historySection.style.display = 'block';
        historyMessages.innerHTML = '';
        recentHistory.forEach(entry => {
          const userDiv = document.createElement('div');
          userDiv.className = 'history-message history-user';
          userDiv.textContent = `あなた: ${entry.user}`;
          historyMessages.appendChild(userDiv);

          const botDiv = document.createElement('div');
          botDiv.className = 'history-message history-bot';
          botDiv.innerHTML = `AI HARUOMI: ${entry.bot}`;
          historyMessages.appendChild(botDiv);
        });
      }
    }

    function clearHistory() {
      localStorage.removeItem(STORAGE_KEY);
      historySection.style.display = 'none';
      alert('履歴をクリアしました。');
    }

    function saveCheckboxState() {
      localStorage.setItem('saveHistoryChecked', saveHistoryToggle.checked);
    }

    function loadCheckboxState() {
      const savedState = localStorage.getItem('saveHistoryChecked');
      saveHistoryToggle.checked = savedState !== null ? savedState === 'true' : true;
    }

    sendBtn.addEventListener('click', () => {
      const input = userInput.value.trim();
      if (input) {
        addMessage(input, true);
        const botResponse = getBotResponse(input);
        setTimeout(() => {
          addMessage(botResponse, false);
          saveToHistory(input, botResponse);
        }, 500);
        userInput.value = '';
      }
    });

    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendBtn.click();
      }
    });

    clearHistoryBtn.addEventListener('click', clearHistory);
    saveHistoryToggle.addEventListener('change', saveCheckboxState);

    window.onload = () => {
      loadCheckboxState();
      loadHistory();
    };
  </script>
</body>
</html>
